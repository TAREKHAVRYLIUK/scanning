<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ВІДДАЛЕНЕ СКАНУВАННЯ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- {/* Google Fonts */} -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        h1, h2, h3 { font-family: 'Merriweather', serif; }
        .icon { width: 1em; height: 1em; display: inline-block; vertical-align: middle; margin-right: 0.25em; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #image-display-container img { display: block; margin: 1rem auto; max-width: 250px; max-height: 250px; border: 1px solid #ddd; padding: 4px; border-radius: 4px; background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 200px; height: 200px; background-color: #f8f8f8; border: 1px dashed #ccc; color: #888; text-align: center; margin: 1rem auto; border-radius: 4px; padding: 1rem; }
        .image-placeholder .icon { margin-bottom: 0.5rem; margin-right: 0; }
    </style>

    <!-- {/* React & ReactDOM */} -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- {/* Babel Standalone */} -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- {/* Supabase Client Library */} -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>
<body class="bg-gradient-to-br from-gray-100 via-white to-gray-200">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext, Component } = React;
        const { createClient } = supabase;

        // --- !! ВАЖЛИВО: Вставте сюди ваші Supabase URL та Anon Key !! ---
        const SUPABASE_URL = 'https://qxrkqeqhyyczehdobmdk.supabase.co'; // Замініть на ваш URL проекту Supabase
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4cmtxZXFoeXljemVoZG9ibWRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM1OTc0NDYsImV4cCI6MjA1OTE3MzQ0Nn0.3zEwSavme0ujD7loYW_ucLZLhoo9nIhIvU0GQJktfjA'; // Замініть на ваш Anon Key

        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            console.warn("Supabase URL або Anon Key не встановлено! Будь ласка, замініть плейсхолдери.");
        }

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- React Context ---
        const AppContext = createContext();

        function AppProvider({ children }) { /* ... без змін ... */
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            const ADMIN_EMAIL = 'tarasfanatasy@gmail.com'; // ЗАМІНІТЬ НА ВАШ EMAIL АДМІНА

            useEffect(() => {
                let mounted = true;
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    if (mounted) { setSession(session); setLoading(false); }
                }).catch(err => {
                     console.error("Error getting initial session:", err);
                     if (mounted) setLoading(false);
                });
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                     if (mounted) { setSession(session); }
                     if (_event === 'SIGNED_IN') console.log('User signed in:', session?.user?.email);
                     if (_event === 'SIGNED_OUT') console.log('User signed out');
                });
                return () => { mounted = false; subscription?.unsubscribe(); }
            }, []);

            const isAdmin = session?.user?.email === ADMIN_EMAIL;
            const loggedInUserIdentifier = session?.user?.id ?? null;
            const loggedInUserEmail = session?.user?.email ?? null;

            const value = { supabase: supabaseClient, session, loading, isAdmin, loggedInUserIdentifier, loggedInUserEmail };
            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        }

        // --- Error Boundary ---
        class ErrorBoundary extends Component { /* ... без змін ... */
          constructor(props) {
            super(props);
            this.state = { hasError: false, error: null, errorInfo: null };
          }
          static getDerivedStateFromError(error) { return { hasError: true, error: error }; }
          componentDidCatch(error, errorInfo) {
            this.setState({ errorInfo: errorInfo });
            console.error("ErrorBoundary caught an error:", error, errorInfo);
          }
          render() {
            if (this.state.hasError) {
              return (
                  <div className="p-4 m-4 text-center text-red-800 bg-red-100 border border-red-400 rounded">
                      <h1 className="text-xl font-bold">Щось пішло не так...</h1>
                      <p className="mt-2">Виникла помилка при відображенні компонента.</p>
                      <p className="mt-1 text-sm">Будь ласка, перевірте консоль розробника (F12) для деталей.</p>
                      <pre className="mt-3 text-xs text-left bg-red-50 p-2 rounded whitespace-pre-wrap overflow-auto">
                          {this.state.error?.toString()}
                      </pre>
                  </div>
              );
            }
            return this.props.children;
          }
        }

        // --- Lucide Icon URLs ---
        const ICONS = { /* ... icons ... */
            shield: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/shield.svg',
            user: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/user.svg',
            users: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/users.svg',
            plus: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/plus.svg',
            save: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/save.svg',
            trash: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/trash-2.svg',
            login: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/log-in.svg',
            logout: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/log-out.svg',
            edit: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/edit.svg',
            x: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/x.svg',
            check: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/check.svg',
            image: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/image.svg',
            imageOff: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/image-off.svg',
            key: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/key-round.svg',
            alertTriangle: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/alert-triangle.svg',
            mail: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/mail.svg',
            loader: 'https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/loader-2.svg'
        };

        // Icon Component Helper
        function Icon({ name, className = '', invert = false, spin = false }) { /* ... без змін ... */
            const url = ICONS[name];
            if (!url) return null;
            let combinedClassName = `icon ${className}`.trim();
             if (spin) { combinedClassName += ' animate-spin'; }
            const style = invert ? { filter: 'brightness(0) invert(1)' } : {};
            return <img src={url} alt={`${name} icon`} className={combinedClassName} style={style} onError={(e) => e.target.style.display='none'} />;
        }

        // --- Components ---

        // Login Screen Component
        function LoginScreen() { /* ... JSX без змін ... */
            const { supabase } = useContext(AppContext);
            const [loading, setLoading] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loginError, setLoginError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setLoginError('');
                try {
                    const { error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                } catch (error) {
                    console.error("Login error:", error);
                    setLoginError(error.error_description || error.message || 'Помилка входу.');
                } finally { setLoading(false); }
            };

            return (
                <div className="flex items-center justify-center min-h-[calc(100vh-200px)] p-4">
                    <div className="w-full max-w-sm p-6 md:p-8 bg-white rounded-xl shadow-lg space-y-6 border-t-4 border-[#F40009]">
                        <h2 className="text-3xl font-bold text-center text-gray-800">Вхід</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                             <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-600 mb-1">
                                    Email
                                </label>
                                <div className="relative">
                                     <span className="absolute inset-y-0 left-0 pl-3 flex items-center">
                                        <Icon name="mail" className="text-gray-400"/>
                                     </span>
                                     <input
                                        id="email"
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                        placeholder="Ваш email"
                                        className="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-[#F40009] focus:border-[#F40009] transition duration-150 ease-in-out"
                                    />
                                </div>
                            </div>
                            <div>
                                <label htmlFor="password" className="block text-sm font-medium text-gray-600 mb-1">
                                    Пароль
                                </label>
                                <div className="relative">
                                     <span className="absolute inset-y-0 left-0 pl-3 flex items-center">
                                        <Icon name="key" className="text-gray-400"/>
                                     </span>
                                     <input
                                        id="password"
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                        placeholder="Ваш пароль"
                                        className="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-[#F40009] focus:border-[#F40009] transition duration-150 ease-in-out"
                                    />
                                </div>
                            </div>
                            {loginError && (
                                <p className="text-sm text-red-600 flex items-center">
                                    <Icon name="alertTriangle" className="text-red-500 mr-1"/>
                                    {loginError}
                                </p>
                            )}
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-semibold rounded-md shadow-sm text-white bg-[#F40009] hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out disabled:opacity-50"
                            >
                                {loading ? <Icon name="loader" spin={true} invert={true}/> : <Icon name="login" className="mr-1" invert={true}/>}
                                {loading ? 'Вхід...' : 'Увійти'}
                            </button>
                        </form>
                         <p className="text-xs text-gray-500 text-center mt-4">
                            Реєстрація в закритому режимі.
                         </p>
                    </div>
                </div>
            );
        }


        // Admin Dashboard Component
        function AdminDashboard() { /* ... state and other functions ... */
          const { supabase } = useContext(AppContext);
          const [clients, setClients] = useState([]);
          const [loadingClients, setLoadingClients] = useState(true);
          const [errorClients, setErrorClients] = useState(null);
          const [users, setUsers] = useState([]);
          const [loadingUsers, setLoadingUsers] = useState(false);
          const [newClientName, setNewClientName] = useState('');
          const [selectedUserId, setSelectedUserId] = useState('');
          const [editingClientId, setEditingClientId] = useState(null);
          const [currentImageUrl, setCurrentImageUrl] = useState('');
          const [editingAssignedUserId, setEditingAssignedUserId] = useState('');
          const [isSubmitting, setIsSubmitting] = useState(false);

          useEffect(() => {
            fetchClients();
            fetchUsers();
          }, []);

          async function fetchClients() { /* ... без змін ... */
              setLoadingClients(true); setErrorClients(null);
              try {
                  const { data, error } = await supabase.from('clients').select('*').order('created_at', { ascending: false });
                  if (error) throw error;
                  setClients(data || []);
              } catch (error) {
                  console.error("Error fetching clients:", error);
                  setErrorClients(`Не вдалося завантажити клієнтів. (${error.message}). Перевірте RLS політики.`);
              } finally { setLoadingClients(false); }
          }

          async function fetchUsers() { /* ... без змін ... */
              setLoadingUsers(true);
              console.log("Attempting to fetch real users for dropdown...");
              try {
                  console.log("Fetching users from 'profiles' table...");
                  const { data, error } = await supabase
                      .from('profiles')
                      .select('id, email');

                  if (error) {
                      console.error("Error fetching profiles:", error);
                      throw new Error(`Не вдалося завантажити профілі користувачів. (${error.message}). Перевірте 'profiles' та RLS.`);
                  }
                  setUsers(data || []);
                  console.log("Fetched real users for dropdown:", data);
              } catch (error) {
                  console.error("Error in fetchUsers:", error);
                  setUsers([]);
                  alert("Помилка завантаження списку користувачів: " + error.message);
              } finally {
                   setLoadingUsers(false);
              }
          }

          const handleAddClient = async (e) => { /* ... без змін ... */
            e.preventDefault(); if (!newClientName.trim()) return; setIsSubmitting(true);
            try {
                const newClientData = { name: newClientName.trim(), assigned_user_id: selectedUserId || null };
                console.log("Adding client with data:", newClientData);
                const { data, error } = await supabase.from('clients').insert(newClientData).select();
                if (error) {
                    console.error("Supabase insert error:", error);
                    let message = `Помилка додавання клієнта: ${error.message}.`;
                    if (error.details) message += ` Деталі: ${error.details}`;
                    if (error.hint) message += ` Підказка: ${error.hint}`;
                     if (error.code === '23503') message += ' Можливо, вибрано неіснуючий ID користувача або є проблема зі зв\'язком таблиць.';
                     if (error.code === '42501') message += ' Можливо, відсутня або неправильна RLS політика для операції INSERT.';
                     if (error.code === '23502') message += ` Порушення обмеження NOT NULL для колонки '${error.message.match(/column "(\w+)"/)?.[1]}'. Перевірте налаштування таблиці.`;
                    throw new Error(message);
                 }
                console.log("Insert successful, inserted data:", data);
                setNewClientName(''); setSelectedUserId('');
                await fetchClients();
            } catch(error) {
                 console.error("Error adding client (catch block):", error);
                 alert(error.message || "Невідома помилка при додаванні клієнта.");
            } finally { setIsSubmitting(false); }
          };

          const handleEditClick = (client) => { /* ... без змін ... */
            setEditingClientId(client.id);
            setCurrentImageUrl(client.image_url || '');
            setEditingAssignedUserId(client.assigned_user_id || '');
          };

          const handleCancelEdit = () => { /* ... без змін ... */
            setEditingClientId(null);
            setCurrentImageUrl('');
            setEditingAssignedUserId('');
          };

          const handleSaveUrl = async (clientId) => { /* ... без змін ... */
             setIsSubmitting(true);
             try {
                console.log(`Updating client ${clientId} with image URL: ${currentImageUrl.trim()}`);
                const { error } = await supabase
                    .from('clients')
                    .update({ image_url: currentImageUrl.trim() })
                    .eq('id', clientId);
                 if (error) throw error;
                 await fetchClients();
                 alert("URL зображення оновлено!");
             } catch(error) {
                  console.error("Error updating image URL:", error); alert(`Помилка оновлення URL: ${error.message}`);
             } finally { setIsSubmitting(false); }
          };

           const handleSaveAssignment = async (clientId) => { /* ... без змін ... */
             setIsSubmitting(true);
             try {
                 const newAssignedId = editingAssignedUserId || null;
                 console.log(`Updating client ${clientId} assignment to user ID: ${newAssignedId}`);
                 const { error } = await supabase
                    .from('clients')
                    .update({ assigned_user_id: newAssignedId })
                    .eq('id', clientId);
                 if (error) throw error;
                 await fetchClients();
                 alert("Призначення користувача оновлено!");
             } catch(error) {
                  console.error("Error updating assignment:", error); alert(`Помилка оновлення призначення: ${error.message}`);
             } finally { setIsSubmitting(false); }
           };


           // --- handleDeleteClient - ВИДАЛЕНО window.confirm ---
           const handleDeleteClient = async (clientId) => {
               // Confirmation removed due to sandbox limitations
               // Підтвердження видалено через обмеження середовища
               // if (window.confirm('Ви впевнені, що хочете видалити цього клієнта та його дані?')) {
                   setIsSubmitting(true);
                   console.log(`Attempting to delete client with ID: ${clientId}`);
                   try {
                       const { data, error } = await supabase.from('clients').delete().eq('id', clientId);

                       console.log("Supabase delete response:", { data, error });

                       if (error) {
                           throw error;
                       }

                       console.log("Delete successful for client:", clientId);
                       await fetchClients();
                       if (editingClientId === clientId) { handleCancelEdit(); }
                   } catch(error) {
                       console.error("Error deleting client (catch block):", error);
                       let message = `Помилка видалення клієнта: ${error.message}`;
                       if (error.details) message += ` Деталі: ${error.details}`;
                       if (error.hint) message += ` Підказка: ${error.hint}`;
                       if (error.code === '42501') message += ' Можливо, відсутня або неправильна RLS політика для операції DELETE.';
                       if (error.code === '23503') message += ' Можливо, існують інші записи, що посилаються на цього клієнта (foreign key constraint).';
                       alert(message); // Alert might still be blocked, check console
                   } finally {
                       setIsSubmitting(false);
                   }
               // } // End of removed window.confirm
           };
          // --- КІНЕЦЬ handleDeleteClient ---

           if (loadingClients) { /* ... loading state ... */
               return <div className="flex justify-center items-center p-10"><Icon name="loader" className="w-8 h-8" spin={true}/> <span className="ml-2">Завантаження клієнтів...</span></div>;
           }
           if (errorClients) { /* ... error state ... */
               return <div className="text-red-600 p-4 bg-red-100 rounded text-center">{errorClients}</div>;
           }

           console.log('Populating dropdown with users:', users);

          return ( /* ... JSX для AdminDashboard ... */
            <div className="space-y-6 p-4 md:p-6 bg-gray-50/80 rounded-lg shadow">
              <h2 className="text-2xl font-semibold text-gray-800 flex items-center border-b pb-2 border-gray-200">
                <Icon name="shield" className="text-[#F40009]"/> Панель Адміністратора
              </h2>

              {/* Add New Client Form */}
              <form onSubmit={handleAddClient} className="space-y-4 p-4 border border-gray-200 rounded-md bg-white shadow-sm">
                 {/* ... Form fields for name and user assignment ... */}
                 <h3 className="text-xl font-semibold text-gray-700">Додати нового клієнта</h3>
                <div>
                    <label htmlFor="clientName" className="block text-sm font-medium text-gray-600 mb-1">
                      Ім'я клієнта
                    </label>
                    <input
                      id="clientName"
                      type="text"
                      value={newClientName}
                      onChange={(e) => setNewClientName(e.target.value)}
                      placeholder="Введіть ім'я клієнта"
                      required
                      className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-[#F40009] focus:border-[#F40009] transition duration-150 ease-in-out"
                    />
                </div>
                 <div>
                    <label htmlFor="assignUser" className="block text-sm font-medium text-gray-600 mb-1">
                        Призначити користувачу
                    </label>
                    <select
                        id="assignUser"
                        value={selectedUserId}
                        onChange={(e) => setSelectedUserId(e.target.value)}
                        disabled={loadingUsers}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-[#F40009] focus:border-[#F40009] transition duration-150 ease-in-out bg-white disabled:bg-gray-100"
                    >
                        <option value="">-- Не призначено --</option>
                        {loadingUsers ? (
                             <option value="" disabled>Завантаження...</option>
                        ) : users && users.length > 0 ? (
                            users.map(user => (
                                <option key={user.id} value={user.id}>{user.email}</option>
                            ))
                        ) : (
                            <option value="" disabled>Користувачів не знайдено</option>
                        )}
                    </select>
                     {loadingUsers && <Icon name="loader" className="inline-block ml-2 w-4 h-4" spin={true}/>}
                 </div>
                  <button
                    type="submit"
                    disabled={isSubmitting || loadingUsers}
                    className="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-[#F40009] hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out disabled:opacity-50"
                  >
                     {isSubmitting ? <Icon name="loader" spin={true} invert={true}/> : <Icon name="plus" className="mr-1" invert={true}/>}
                     {isSubmitting ? 'Додавання...' : 'Додати Клієнта'}
                  </button>
              </form>

              {/* Client List */}
              <div className="space-y-4">
                <h3 className="text-xl font-semibold text-gray-700">Список клієнтів</h3>
                {clients.length === 0 ? ( /* ... no clients message ... */
                  <p className="text-gray-500 italic">Клієнти ще не додані.</p>
                ) : (
                  <ul className="space-y-3">
                    {clients.map((client) => (
                      <li key={client.id} className="p-4 border border-gray-200 rounded-md bg-white shadow-sm space-y-3">
                        {/* Client Info Row */}
                        <div className="flex flex-col md:flex-row md:justify-between md:items-start">
                           {/* ... client name and assignment display ... */}
                           <div>
                               <span className="font-semibold text-lg text-gray-800">{client.name}</span>
                               <div className="text-xs text-gray-500 flex items-center mt-1">
                                  <Icon name="users" className="mr-1 text-gray-400"/>
                                   Призначено: {client.assigned_user_id ? <code className="bg-gray-100 px-1 rounded text-gray-700" title={client.assigned_user_id}>ID: ...{client.assigned_user_id.slice(-6)}</code> : <span className="italic">Нікому</span>}
                               </div>
                           </div>
                           <div className="flex items-center space-x-2 flex-shrink-0 mt-2 md:mt-0">
                             {/* Edit button */}
                             <button
                                onClick={() => handleEditClick(client)}
                                disabled={isSubmitting || editingClientId === client.id}
                                className="text-sm text-gray-600 hover:text-[#F40009] transition duration-150 ease-in-out flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                                title="Редагувати"
                              >
                                 <Icon name="edit" className="mr-1"/> Редагувати
                              </button>
                             {/* Delete button */}
                             <button
                               onClick={() => {
                                   console.log(`Delete button clicked for client ID: ${client.id}`); // Log click event
                                   handleDeleteClient(client.id);
                               }}
                               disabled={isSubmitting} // Simplified disabled logic
                               className="text-sm text-red-500 hover:text-red-700 transition duration-150 ease-in-out flex items-center disabled:opacity-50"
                               title="Видалити клієнта"
                             >
                               <Icon name="trash" />
                             </button>
                           </div>
                        </div>

                        {/* Editing Section */}
                        {editingClientId === client.id && ( /* ... JSX без змін ... */
                          <div className="space-y-4 pt-3 mt-3 border-t border-gray-100">
                            {/* Edit Image URL */}
                            <div className="space-y-2">
                                <label htmlFor={`imageUrl-${client.id}`} className="block text-sm font-medium text-gray-600">
                                  URL зображення:
                                </label>
                                <div className="flex items-center space-x-2">
                                    <input
                                      type="url"
                                      id={`imageUrl-${client.id}`}
                                      value={currentImageUrl}
                                      onChange={(e) => setCurrentImageUrl(e.target.value)}
                                      placeholder="Вставте URL зображення тут..."
                                      className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-[#F40009] focus:border-[#F40009] transition duration-150 ease-in-out"
                                    />
                                    <button
                                        onClick={() => handleSaveUrl(client.id)}
                                        disabled={isSubmitting}
                                        title="Зберегти URL зображення"
                                        className="inline-flex items-center px-3 py-2 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-gray-700 hover:bg-black focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out disabled:opacity-50"
                                      >
                                        {isSubmitting ? <Icon name="loader" spin={true} invert={true}/> : <Icon name="save" invert={true}/>}
                                      </button>
                                </div>
                            </div>
                             {/* Edit Assignment */}
                             <div className="space-y-2">
                                <label htmlFor={`editAssignUser-${client.id}`} className="block text-sm font-medium text-gray-600">
                                    Змінити призначення:
                                </label>
                                <div className="flex items-center space-x-2">
                                    <select
                                        id={`editAssignUser-${client.id}`}
                                        value={editingAssignedUserId}
                                        onChange={(e) => setEditingAssignedUserId(e.target.value)}
                                        disabled={loadingUsers || isSubmitting}
                                        className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-[#F40009] focus:border-[#F40009] transition duration-150 ease-in-out bg-white disabled:bg-gray-100"
                                    >
                                        <option value="">-- Не призначено --</option>
                                        {loadingUsers ? (
                                             <option value="" disabled>Завантаження...</option>
                                        ) : users && users.length > 0 ? (
                                            users.map(user => (
                                                <option key={user.id} value={user.id}>{user.email}</option>
                                            ))
                                        ) : (
                                            <option value="" disabled>Користувачів не знайдено</option>
                                        )}
                                    </select>
                                     <button
                                        onClick={() => handleSaveAssignment(client.id)}
                                        disabled={isSubmitting || loadingUsers}
                                        title="Зберегти Призначення"
                                        className="inline-flex items-center px-3 py-2 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:opacity-50"
                                      >
                                        {isSubmitting ? <Icon name="loader" spin={true} invert={true}/> : <Icon name="save" invert={true}/>}
                                      </button>
                                </div>
                             </div>
                             {/* Cancel Edit Button */}
                             <div className="flex justify-end">
                                  <button
                                    onClick={handleCancelEdit}
                                    disabled={isSubmitting}
                                    className="inline-flex items-center px-3 py-1 border border-gray-300 text-xs font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150 ease-in-out disabled:opacity-50"
                                  >
                                    <Icon name="x" className="mr-1"/> Завершити редагування
                                  </button>
                             </div>
                          </div>
                        )}

                        {/* Display Image URL (only when not editing) */}
                        {editingClientId !== client.id && ( /* ... display row JSX ... */
                             <div className="text-sm text-gray-600 pt-2 mt-2 border-t border-gray-100 flex items-center space-x-2">
                                 <Icon name={client.image_url ? "image" : "imageOff"} className="text-gray-400 flex-shrink-0"/>
                                <span className="font-medium flex-shrink-0">URL зображення:</span>
                                {client.image_url ? (
                                    <a href={client.image_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 hover:underline truncate" title={client.image_url}>
                                        {client.image_url}
                                    </a>
                                ) : (
                                    <span className="italic text-gray-400">Немає</span>
                                )}
                              </div>
                        )}
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </div>
          );
        }

        // User Dashboard Component
        function UserDashboard() { /* ... JSX без змін ... */
          const { supabase, session, loggedInUserEmail } = useContext(AppContext);
          const [clients, setClients] = useState([]);
          const [loadingClients, setLoadingClients] = useState(true);
          const [errorClients, setErrorClients] = useState(null);
          const [selectedClientId, setSelectedClientId] = useState('');
          const [selectedImageUrl, setSelectedImageUrl] = useState('');
          const [imageError, setImageError] = useState(false);

          useEffect(() => {
               if (session?.user?.id) {
                   fetchUserClients(session.user.id);
               } else {
                   setLoadingClients(false);
                   setClients([]);
               }
           }, [session]);

           async function fetchUserClients(userId) {
               setLoadingClients(true);
               setErrorClients(null);
               try {
                   const { data, error } = await supabase
                       .from('clients')
                       .select('*')
                       .eq('assigned_user_id', userId)
                       .order('created_at', { ascending: false });

                   if (error) throw error;
                   const fetchedClients = data || [];
                   // --- ADD SORTING HERE ---
                   // --- ДОДАТИ СОРТУВАННЯ ТУТ ---
                   fetchedClients.sort((a, b) => a.name.localeCompare(b.name, 'uk')); // Sort alphabetically by name
                   setClients(fetchedClients);

                   if (fetchedClients.length > 0) {
                       // If current selection is invalid or empty after sorting, set to first client
                       // Якщо поточний вибір недійсний або порожній після сортування, встановити першого клієнта
                       if (!selectedClientId || !fetchedClients.some(c => c.id === selectedClientId)) {
                           setSelectedClientId(fetchedClients[0].id);
                       }
                   } else {
                       setSelectedClientId('');
                   }

               } catch (error) {
                   console.error("Error fetching user clients:", error);
                   setErrorClients(`Не вдалося завантажити ваших клієнтів. (${error.message})`);
               } finally {
                   setLoadingClients(false);
               }
           }
          useEffect(() => {
            const selectedClient = clients.find(c => c.id === selectedClientId);
            const newUrl = selectedClient ? selectedClient.image_url : '';
            setSelectedImageUrl(newUrl || '');
            setImageError(false);
          }, [selectedClientId, clients]);


           if (loadingClients) {
               return <div className="flex justify-center items-center p-10"><Icon name="loader" className="w-8 h-8" spin={true}/> <span className="ml-2">Завантаження ваших клієнтів...</span></div>;
           }
           if (errorClients) {
               return <div className="text-red-600 p-4 bg-red-100 rounded text-center">{errorClients}</div>;
           }

          return (
            <div className="space-y-6 p-4 md:p-6 bg-white rounded-lg shadow">
              <h2 className="text-2xl font-semibold text-gray-800 flex items-center border-b pb-2 border-gray-200">
                <Icon name="user" className="text-[#F40009]"/> Панель Користувача <span className="text-base text-gray-500 ml-2">({loggedInUserEmail})</span>
              </h2>

              {clients.length === 0 ? (
                 <p className="text-gray-500 italic text-center py-4">По вашій базі дані відсутні</p>
              ) : (
                <div className="space-y-4 flex flex-col items-center">
                    {/* Client Selector */}
                    <div>
                      <label htmlFor="clientSelect" className="block text-sm font-medium text-gray-700 mb-1 text-center">
                        Оберіть клієнта за ПІБ:
                      </label>
                      <select
                        id="clientSelect"
                        value={selectedClientId}
                        onChange={(e) => setSelectedClientId(e.target.value)}
                        className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-1 focus:ring-[#F40009] focus:border-[#F40009] sm:text-sm rounded-md shadow-sm bg-white"
                      >
                        {clients.map((client) => (
                          <option key={client.id} value={client.id}>
                            {client.name}
                          </option>
                        ))}
                      </select>
                    </div>

                    {/* Image Display */}
                    <div className="mt-6 text-center p-4 border border-dashed border-gray-300 rounded-lg bg-gray-50 w-full max-w-sm mx-auto">
                      <h3 className="text-lg font-semibold text-gray-700 mb-3">Зображення для клієнта</h3>
                      <div id="image-display-container" className="min-h-[220px] flex items-center justify-center">
                          {selectedClientId && selectedImageUrl && !imageError ? (
                            <img
                                src={selectedImageUrl}
                                alt={`Зображення для клієнта`}
                                onError={() => setImageError(true)}
                            />
                          ) : selectedClientId && imageError ? (
                             <div className="image-placeholder">
                                <Icon name="imageOff" className="w-8 h-8 text-red-500"/>
                                <span>Помилка завантаження зображення за вказаним URL.</span>
                             </div>
                          ) : selectedClientId && !selectedImageUrl ? (
                            <div className="image-placeholder">
                                <Icon name="imageOff" className="w-8 h-8"/>
                                <span>Для цього клієнта URL зображення не додано.</span>
                            </div>
                          ) : (
                             <p className="text-gray-500 italic px-4">Оберіть клієнта для відображення зображення.</p>
                          )}
                      </div>
                    </div>
                </div>
              )}
            </div>
          );
        }


        // Main App Component
        function App() { /* ... JSX без змін ... */
            const { session, loading, isAdmin, supabase, loggedInUserEmail } = useContext(AppContext);

            const handleLogout = async () => {
                const { error } = await supabase.auth.signOut();
                if (error) console.error('Error logging out:', error);
            };

            if (loading) {
                 return (
                     <div className="flex items-center justify-center h-screen">
                         <Icon name="loader" className="w-12 h-12 text-[#F40009]" spin={true}/>
                     </div>
                 );
            }

          return (
            <div className="min-h-screen p-4 sm:p-8">
              <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden border-2 border-gray-200">
                 {/* Header */}
                <header className="p-4 sm:p-5 bg-[#F40009] text-white shadow-md">
                  <div className="flex flex-col sm:flex-row justify-between items-center">
                     <h1 className="text-3xl sm:text-4xl font-bold mb-2 sm:mb-0 text-center sm:text-left" style={{ fontFamily: "'Merriweather', serif" }}>
                        Система Віддаленого Сканування
                     </h1>
                     {session && (
                         <button
                           onClick={handleLogout}
                           className={`px-3 py-1 rounded-md text-sm font-semibold flex items-center transition duration-150 ease-in-out bg-white text-[#F40009] hover:bg-gray-200`}
                         >
                            <Icon name="logout" className="mr-1" invert={true}/> Вийти ({isAdmin ? 'Адмін' : loggedInUserEmail})
                         </button>
                     )}
                  </div>
                </header>

                {/* Main Content Area */}
                <main className="p-4 sm:p-6 bg-gray-50">
                  {!session ? (
                    <LoginScreen />
                  ) : isAdmin ? (
                    <AdminDashboard />
                  ) : (
                    <UserDashboard />
                  )}
                </main>

                 {/* Footer */}
                 <footer className="text-center p-3 bg-gray-800 text-gray-300 border-t border-gray-700">
                    <p className="text-xs">&copy; {new Date().getFullYear()} SECRET SUPPORT TEAM</p>
                 </footer>
              </div>
            </div>
          );
        }

        // Mount the React app with the Provider and Error Boundary
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
          <ErrorBoundary>
            <AppProvider>
                <App />
            </AppProvider>
          </ErrorBoundary>
        );

    </script>

</body>
</html>
